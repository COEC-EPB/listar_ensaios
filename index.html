<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ensaios Dielétricos - Consulta</title>

<style>
body {
    font-family: Arial;
    background: #f4f7fc;
    padding: 20px;
}
table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}
th, td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
}
th {
    background: #0077b6;
    color: white;
}
button {
    padding: 6px 12px;
    background: #0077b6;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
button:hover {
    background: #005f87;
}
.modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,.4);
    display: none;
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 300px;
}
</style>

</head>
<body>

<h2>Ensaios Dielétricos Registrados</h2>

<table id="tabela">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Equipamentos</th>
            <th>Resultado</th>
            <th>Aprovação</th>
            <th>Ação</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>


<!-- MODAL APROVAÇÃO -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Nº de Aprovação</h3>
    <input id="numeroAprovacao" style="width:100%;padding:8px" placeholder="000/2025">
    <br><br>
    <button onclick="salvarAprovacao()">Salvar</button>
    <button onclick="fecharModal()" style="background:#999;margin-left:5px">Cancelar</button>
  </div>
</div>

<script>
let ensaioSelecionado = null;
const API = "https://ensai-dieletrico.pedro-fillype.workers.dev";

async function carregar() {
    const r = await fetch(`${API}/listar-ensaios`);
    const ensaios = await r.json();

    const tbody = document.querySelector("#tabela tbody");
    tbody.innerHTML = "";

    ensaios.forEach(e => {
        tbody.innerHTML += `
        <tr>
            <td>${e.id}</td>
            <td>${e.nome}</td>
            <td>${e.equipamentos}</td>
            <td>${e.resultado}</td>
            <td>${e.aprovacao ?? '-'}</td>
            <td>
                ${e.aprovacao 
                    ? `<a href="${API}/gerar-pdf?id=${e.id}" download><button>Download PDF</button></a>`
                    : `<button onclick="abrirModal(${e.id})">Gerar PDF</button>`
                }
            </td>
        </tr>`;
    });
}

function abrirModal(id) {
    ensaioSelecionado = id;
    document.getElementById("modal").style.display = "flex";
}

function fecharModal() {
    document.getElementById("modal").style.display = "none";
}

async function salvarAprovacao() {
    const aprov = document.getElementById("numeroAprovacao").value;

    await fetch(`${API}/salvar-aprovacao`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: ensaioSelecionado, aprovacao: aprov })
    });

    fecharModal();
    carregar();
}

carregar();
</script>

</body>
</html>
