<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ensaios Diel√©tricos - Consulta (Modelo)</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
    body {
        font-family: "Segoe UI", Arial;
        background: #eef3f8;
        padding: 30px;
    }
    .container {
        max-width: 1300px;
        margin: auto;
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,.08);
    }
    h2 {
        margin-bottom: 20px;
        color: #003d66;
    }
    .filtros {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    .filtros input,
    .filtros select {
        padding: 10px;
        font-size: 15px;
        border-radius: 6px;
        border: 1px solid #ccc;
        width: 100%;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 12px;
        overflow: hidden;
    }
    th {
        background: #0066a6;
        color: #fff;
        padding: 12px;
        text-align: left;
    }
    td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
    }
    tr:hover { background: #f2f8fc; }
    .btn { padding: 7px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: .2s; }
    .btn-primary { background: #0077c2; color: #fff; }
    .btn-primary:hover { background: #005f99; }
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,.5); display:none; justify-content:center; align-items:center; }
    .modal-content { background:white; padding:25px; border-radius:12px; width:320px; text-align:center; box-shadow:0 5px 20px rgba(0,0,0,.2); }
</style>
</head>
<body>

<div class="container">
    <h2>Ensaios Diel√©tricos Registrados</h2>

    <!-- FILTROS -->
    <div class="filtros">
        <input id="filtroNome" placeholder="Filtrar por nome">
        <input id="filtroEquipamento" placeholder="Filtrar por equipamento">
        <select id="filtroAprovacao">
            <option value="">Aprova√ß√£o (todos)</option>
            <option value="-">Sem aprova√ß√£o</option>
            <option value="ap">Aprovados</option>
        </select>
        <input id="buscaGeral" placeholder="Busca inteligente (tudo)">
    </div>

    <table id="tabela">
        <thead>
            <tr>
                <th style="width:6%;">ID</th>
                <th style="width:28%;">Nome</th>
                <th style="width:36%;">Equipamentos</th>
                <th style="width:10%;">Resultado</th>
                <th style="width:10%;">Aprova√ß√£o</th>
                <th style="width:10%;">A√ß√£o</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
    <div class="modal-content">
        <h3>N¬∫ de Aprova√ß√£o</h3>
        <input id="numeroAprovacao" placeholder="000/2025">
        <br><br>
        <button class="btn btn-primary" onclick="salvarAprovacao()">Salvar</button>
        <button class="btn" onclick="fecharModal()">Cancelar</button>
    </div>
</div>

<script>
/* ================================
   NORMALIZA√á√ÉO (remove acentos, uppercase)
================================ */
function normalizar(str) {
    if (!str && str !== "") return "";
    return String(str)
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toUpperCase()
        .trim();
}

/* ==========================================
   MAPA COMPLETO DE IMAGENS POR EQUIPAMENTO
   (chaves ser√£o transformadas para normalizadas)
========================================== */
const BASE = "https://raw.githubusercontent.com/COEC-EPB/listar_ensaios/main/";

const imagensEquipamentos = {
    "ANDAIME ISOLANTE": BASE + "ANDAIME%20ISOLANTE.jpg",
    "ATERRAMENTO MT": BASE + "ATERRAMENTO%20MT.jpg",
    "BANQUETA ISOLADA": BASE + "BANQUETA%20ISOLADA.png",
    "BASTAO ASPIRAL": BASE + "BAST%C3%83O%20ASPIRAL.jpg",
    "BASTAO DE BERCO": BASE + "BAST%C3%83O%20DE%20BER%C3%87O.jpg",
    "BASTAO DE TRACAO": BASE + "BAST%C3%83O%20DE%20TRA%C3%87%C3%83O.jpg",
    "BASTAO GARRA": BASE + "BAST%C3%83O%20GARRA.jpg",
    "BASTAO LISO": BASE + "BAST√ÉO LISO.jpg",
    "BASTAO PEGA TUDO": BASE + "BAST%C3%83O%20PEGA%20TUDO.jpg",
    "BASTAO SEPARADOR DE CORDA": BASE + "BAST%C3%83O%20SEPARADOR%20DE%20CORDA.jpg",
    "BASTAO SUPORTE BY PASS": BASE + "BAST%C3%83O%20SUPORTE%20BY%20PASS.jpg",
    "BASTAO TENSOR": BASE + "BAST%C3%83O%20TENSOR.jpg",
    "BASTAO UNIVERSAL": BASE + "BAST%C3%83O%20UNIVERSAL.jpg",
    "BASTAO VARA DE MANOBRA": BASE + "BAST%C3%83O%20VARA%20DE%20MANOBRA.jpg",
    "BASTAO VARA TELESCOPICA": BASE + "BAST%C3%83O%20VARA%20TELESC%C3%93PICA.jpg",
    "BY PASS DE TP": BASE + "BY%20PASS%20DE%20TP.jpg",
    "BY PASS": BASE + "BY%20PASS.jpg",
    "CAPACETE SEGURANCA": BASE + "CAPACETE%20SEGURAN%C3%87A.jpg",
    "COBERTURA CIRCULAR": BASE + "COBERTURA%20CIRCULAR.png",
    "COBERTURA DE COND FLEXIVEL": BASE + "COBERTURA%20DE%20COND.%20FLEXIVEL.jpg",
    "COBERTURA DE COND RIGIDA": BASE + "COBERTURA%20DE%20COND.%20RIGIDA.jpg",
    "DAC - DISPOSITIVO ABERTURA COM CARGA": BASE + "DAC%20-%20DISPOSITIVO%20ABERTURA%20COM%20CARGA.png",
    "LENCO ISOLANTE LV": BASE + "LEN%C3%87O%20ISOLANTE%20LV.jpg",
    "LUVA ISOLANTE BT": BASE + "LUVA%20ISOLANTE%20BT.jpg",
    "LUVA ISOLANTE MT": BASE + "LUVA%20ISOLANTE%20MT.jpg",
    "LUVA ISOLANTE SED": BASE + "LUVA%20ISOLANTE%20SED.jpg",
    "MANGA ISOLANTE BT": BASE + "MANGA%20ISOLANTE%20BT.jpg",
    "MANGA ISOLANTE MT": BASE + "MANGA%20ISOLANTE%20MT.jpg",
    "MANTA ISOLANTE BT": BASE + "MANTA%20ISOLANTE%20BT.jpg",
    "SEPARADOR DE ESCADA": BASE + "SEPARADOR%20DE%20ESCADA.jpg",
    "SKY LANCA CLASSE A - 138 KW": BASE + "SKY%20LAN%C3%87A%20CLASSE%20A%20-%20138%20KW.jfif",
    "SKY LANCA CLASSE B - 69 KW": BASE + "SKY%20LAN%C3%87A%20CLASSE%20B%20-%2069%20KW.jfif",
    "SKY LANCA CLASSE C - 46 KW": BASE + "SKY%20LAN%C3%87A%20CLASSE%20C%20-%2046%20KW.jfif",
    "TALHA": BASE + "TALHA.jpg",
    "TESOURAO PEQUENO": BASE + "TESOUR%C3%83O%20PEQUENO.jpg",

    "ENERGISA": BASE + "energisa.jfif"
};

/* criar mapa normalizado para lookup r√°pido */
const mapaNormalizado = {};
for (const k in imagensEquipamentos) {
    mapaNormalizado[ normalizar(k) ] = imagensEquipamentos[k];
}

/* ================================
   CONTROLE PRINCIPAL
================================ */
let ensaiosOriginais = [];
let ensaioSelecionado = null;

const API = "https://ensai-dieletrico.pedro-fillype.workers.dev";

async function carregar() {
    const r = await fetch(`${API}/listar-ensaios`);
    ensaiosOriginais = await r.json();
    renderizar(ensaiosOriginais);
}

function renderizar(lista) {
    const tbody = document.querySelector("#tabela tbody");
    tbody.innerHTML = "";

    lista.forEach(e => {
        tbody.innerHTML += `
        <tr>
            <td>${e.id}</td>
            <td>${e.nome}</td>
            <td>${e.equipamentos}</td>
            <td>${e.resultado}</td>
            <td>${e.aprovacao ?? '-'}</td>
            <td>
                <button class='btn btn-primary' onclick='gerarPDF(${JSON.stringify(e)})'>
                    Gerar PDF
                </button>
            </td>
        </tr>`;
    });
}

/* FILTROS */
function aplicarFiltros() {
    let nome = filtroNome.value.toLowerCase();
    let eqp = filtroEquipamento.value.toLowerCase();
    let aprov = filtroAprovacao.value;
    let geral = buscaGeral.value.toLowerCase();

    let filtrados = ensaiosOriginais.filter(e => {
        return (
            e.nome.toLowerCase().includes(nome) &&
            e.equipamentos.toLowerCase().includes(eqp) &&
            (aprov === "" ||
             (aprov === "-" && !e.aprovacao) ||
             (aprov === "ap" && e.aprovacao)) &&
            (geral === "" ||
             JSON.stringify(e).toLowerCase().includes(geral))
        );
    });

    renderizar(filtrados);
}

document.querySelectorAll("#filtroNome, #filtroEquipamento, #filtroAprovacao, #buscaGeral")
.forEach(el => el.addEventListener("input", aplicarFiltros));

function abrirModal(id) {
    ensaioSelecionado = id;
    modal.style.display = "flex";
}

function fecharModal() {
    modal.style.display = "none";
}

/* ============================
   SALVAR APROVA√á√ÉO
============================ */
async function salvarAprovacao() {
    const aprov = document.getElementById("numeroAprovacao").value;

    await fetch(`${API}/salvar-aprovacao`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ id: ensaioSelecionado, aprovacao: aprov })
    });

    fecharModal();
    carregar();
}

/* ============================
   GERAR PDF (MODELO EXATO)
============================ */
async function gerarPDF(e) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });

    /* ========== helpers ========== */
    function addImageFromPath(path, x, y, w, h) {
        return new Promise(async (resolve) => {
            try {
                const res = await fetch(path);
                if (!res.ok) return resolve(false);
                const blob = await res.blob();
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result;
                    // detect image type
                    const mime = base64.split(",")[0].match(/data:(image\/[a-zA-Z]+);/);
                    const format = mime ? mime[1].split("/")[1].toUpperCase() : "JPEG";
                    doc.addImage(base64, format, x, y, w, h);
                    resolve(true);
                };
                reader.readAsDataURL(blob);
            } catch (err) {
                resolve(false);
            }
        });
    }

    /* formatar data e m√™s */
    const dataFormatada = e.data ? new Date(e.data).toLocaleDateString("pt-BR") : "";
    const meses = [
        "01 - JANEIRO","02 - FEVEREIRO","03 - MAR√áO","04 - ABRIL",
        "05 - MAIO","06 - JUNHO","07 - JULHO","08 - AGOSTO",
        "09 - SETEMBRO","10 - OUTUBRO","11 - NOVEMBRO","12 - DEZEMBRO"
    ];
    const mes = e.data ? meses[new Date(e.data).getMonth()] : "";

    /* === HEADER: logo + t√≠tulo centralizado === */
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 12;

    // logo energisa (pequena, canto esquerdo)
    const logoPath = mapaNormalizado[ normalizar("ENERGISA") ] || "listar_ensaios/energisa.jfif";
    await addImageFromPath(logoPath, 14, 8, 28, 18).catch(()=>{});

    doc.setFontSize(16);
    doc.setFont("Helvetica", "bold");
    doc.text("LAUDO DE ENSAIO DIEL√âTRICO", pageWidth/2, y, { align: "center" });
    y += 8;

    // espa√ßo antes da tabela de cabe√ßalho
    y += 4;

    /* === TABELA CABE√áALHO (menor largura) === */
    doc.autoTable({
        startY: y,
        theme: "grid",
        tableWidth: 140,       // tabela mais estreita
        margin: { left: 14 },
        styles: { fontSize: 9, cellPadding: 2 },
        head: [["Laudo", "Valor"]],
        headStyles: { fillColor: [0,102,166], textColor: 255, halign: "center" },
        body: [
            ["Laudo", "EPB/EBO"],
            ["Certificado n¬∫", e.aprovacao ?? "-"],
            ["M√™s do Ensaio", mes],
            ["Regional", e.regional],
            ["Localidade", "Jo√£o Pessoa"],
            ["Departamento", e.departamento]
        ]
    });

    let afterHeaderY = doc.lastAutoTable.finalY + 6;

    /* === DOIS BLOCOS: imagem (direita) e info (esquerda) ===
       - deixamos espa√ßo para imagem acima da pequena tabela
       - imagem posicionada em x ~120
    */
    const imgX = 120;
    const imgY = afterHeaderY;
    const imgW = 66;
    const imgH = 66;

    const caminhoImg = getImagemEquipamento(e.equipamentos);

    if (caminhoImg) {
        // add image (se poss√≠vel)
        await addImageFromPath(caminhoImg, imgX, imgY, imgW, imgH).catch(()=>{});
    } else {
        // se n√£o tiver a imagem, pode ser deixado em branco
    }

    // pequena tabela de informa√ß√µes do equipamento (√† esquerda da imagem)
    doc.autoTable({
        startY: afterHeaderY,
        theme: "grid",
        tableWidth: 90,
        margin: { left: 14 },
        styles: { fontSize: 9, cellPadding: 2 },
        head: [["Campo", "Valor"]],
        headStyles: { fillColor: [0,102,166], textColor:255, halign:"center" },
        body: [
            ["Equipamento", e.equipamentos],
            ["Tipo de Ensaio", e.tipo_ensaio],
            ["Norma Aplicada", e.norma]
        ]
    });

    // abaixo da imagem (lado direito) colocamos a tabela menor com tens√£o/corrente/resultado
    const infoRightStartY = afterHeaderY + doc.lastAutoTable.finalY - afterHeaderY;
    // start Y for right small table: align with top of image
    const rightTableY = afterHeaderY;

    doc.autoTable({
        startY: rightTableY,
        theme: "grid",
        tableWidth: 66,
        margin: { left: imgX },
        styles: { fontSize: 8.5, cellPadding: 2 },
        head: [["Campo", "Valor"]],
        headStyles: { fillColor: [243, 189, 0], textColor: 0, halign:"center" },
        body: [
            ["Equipamento", e.equipamentos],
            ["Tipo de Ensaio", e.tipo_ensaio],
            ["Norma", e.norma],
            ["Corrente (¬µA)", e.corrente_fuga],
            ["Resultado", e.resultado]
        ]
    });

    // ajustar finalY para seguir ap√≥s ambos blocos
    let afterBlocksY = Math.max(doc.lastAutoTable.finalY, imgY + imgH) + 10;

    /* === TABELA DE C√ìDIGOS (estreita e leg√≠vel) === */
    // construir elementos entre cod_inicial e cod_final
    const ini = Number(e.cod_inicial || e.cod_inicial || 0);
    const fim = Number(e.cod_final || e.cod_final || ini);
    const rows = [];
    for (let i = ini; i <= fim; i++) {
        rows.push([String(i), String(i), `${e.corrente_fuga} ¬µA`, e.resultado ? e.resultado.toUpperCase() : ""]);
    }

    // se muitos elementos, a autotable cuida da quebra e altura
    doc.autoTable({
        startY: afterBlocksY,
        theme: "grid",
        styles: { fontSize: 9, cellPadding: 2 },
        headStyles: { fillColor: [0,102,166], halign: "center" },
        head: [["C√≥digo", "Rastreamento", "Corrente de Fuga", "Resultado"]],
        body: rows,
        margin: { left: 14, right: 14 },
        columnStyles: {
            0: { cellWidth: 22 }, // c√≥digo estreito
            1: { cellWidth: 30 }, // rastreamento
            2: { cellWidth: 40 }, // corrente
            3: { cellWidth: 40 }  // resultado
        }
    });

    let afterCodigosY = doc.lastAutoTable.finalY + 6;

    // total de elementos
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(10);
    doc.text(`Total de Elementos: ${rows.length}`, 14, afterCodigosY);
    afterCodigosY += 8;

    /* === OBSERVA√á√ïES (menor e em negrito para t√≠tulos) === */
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(11);
    doc.text("Observa√ß√µes", 14, afterCodigosY);
    afterCodigosY += 5;
    doc.setDrawColor(0);
    doc.setLineWidth(0.3);
    doc.line(14, afterCodigosY, pageWidth - 14, afterCodigosY);
    afterCodigosY += 6;

    doc.setFont("Helvetica", "normal");
    doc.setFontSize(8.5);
    const obsLines = [
        "‚Ä¢ Os EPI‚Äôs e EPC‚Äôs com c√≥digo de rastreio correspondente ao laudo est√£o aprovados para uso em campo.",
        "‚Ä¢ Ensaio de Tens√£o Aplicada: Verifica a capacidade diel√©trica sem rompimento ou excesso de corrente.",
        "‚Ä¢ ART do Ensaio Diel√©trico: -",
        "‚Ä¢ Equipamento Utilizado: Testador de Alta Tens√£o EEAT ‚Äì Modelo AT120050CADMT2SAURS232. Certificado Co315225 (Fev/2025) ‚Äì Aprovado.",
        "‚Ä¢ Condi√ß√µes Ambientais: Temperatura: 30¬∞C | Umidade: 50% | Press√£o: 970 mbar",
        "‚Ä¢ Observa√ß√µes gerais: Incerteza na medi√ß√£o de Tens√£o: +/- 0,05% | Incerteza na medi√ß√£o de Corrente: +/- 0,01%"
    ];
    obsLines.forEach(l => {
        doc.text(l, 14, afterCodigosY);
        afterCodigosY += 5;
        // quebra de p√°gina se necess√°rio
        if (afterCodigosY > doc.internal.pageSize.height - 40) {
            doc.addPage();
            afterCodigosY = 20;
        }
    });

    /* === ASSINATURA (rodap√© centralizado com verifica√ß√£o de espa√ßo) === */
    let finalY = afterCodigosY + 12;
    const pageHeight = doc.internal.pageSize.height;
    if (finalY > pageHeight - 30) {
        doc.addPage();
        finalY = 30;
    }

    doc.setFontSize(10);
    doc.text("__________________________________________", pageWidth/2, finalY, { align: "center" });
    finalY += 6;
    doc.setFont("Helvetica", "bold");
    doc.text("Wesley Fernandes de Souza", pageWidth/2, finalY, { align: "center" });
    finalY += 5;
    doc.setFont("Helvetica", "normal");
    doc.setFontSize(9);
    doc.text("Respons√°vel T√©cnico ‚Äì CREA-PB: 1605187852", pageWidth/2, finalY, { align: "center" });

    /* === SALVAR === */
    doc.save(`laudo_${e.id || Date.now()}.pdf`);
}

    /* ============================================================
   1. Normalizar textos (tirar acentos, espa√ßos extras etc.)
============================================================ */
function normalizar(str) {
    if (!str) return "";
    return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toUpperCase()
        .trim();
}

/* ============================================================
   2. CARREGAR AUTOMATICAMENTE TODAS IMAGENS DO GITHUB
============================================================ */
const GITHUB_API =
  "https://api.github.com/repos/COEC-EPB/listar_ensaios/contents/";

const GITHUB_RAW =
  "https://raw.githubusercontent.com/COEC-EPB/listar_ensaios/main/";

let mapaImagens = {}; // ser√° preenchido automaticamente

async function carregarImagensGitHub() {
    try {
        const r = await fetch(GITHUB_API);
        const arquivos = await r.json();

        arquivos.forEach(arq => {
            if (!arq.name.match(/\.(png|jpg|jpeg|jfif)$/i)) return;

            let nome = arq.name.replace(/\.(png|jpg|jpeg|jfif)$/i, "");
            let nomeNormalizado = normalizar(nome);

            mapaImagens[nomeNormalizado] =
                GITHUB_RAW + encodeURIComponent(arq.name);
        });

        console.log("Imagens carregadas:", mapaImagens);
    } catch (err) {
        console.error("Erro ao carregar imagens:", err);
    }
}

/* ============================================================
   3. Fun√ß√£o para obter imagem por nome do equipamento
============================================================ */
function getImagemEquipamento(equipamento) {
    let chave = normalizar(equipamento);
    return mapaImagens[chave] || null;
}


/* iniciar */
(async () => {
    await carregarImagensGitHub();  // üî• primeira coisa: carregar imagens automaticamente
    carregar();                     // depois, carregar sua tabela
})();
</script>

</body>
</html>
