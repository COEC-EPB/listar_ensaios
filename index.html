<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ensaios Dielétricos - Consulta (Modelo)</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
    body {
        font-family: "Segoe UI", Arial;
        background: #eef3f8;
        padding: 30px;
    }
    .container {
        max-width: 1300px;
        margin: auto;
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,.08);
    }
    h2 {
        margin-bottom: 20px;
        color: #003d66;
    }
    .filtros {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    .filtros input,
    .filtros select {
        padding: 10px;
        font-size: 15px;
        border-radius: 6px;
        border: 1px solid #ccc;
        width: 100%;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 12px;
        overflow: hidden;
    }
    th {
        background: #0066a6;
        color: #fff;
        padding: 12px;
        text-align: left;
    }
    td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
    }
    tr:hover { background: #f2f8fc; }
    .btn { padding: 7px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: .2s; }
    .btn-primary { background: #0077c2; color: #fff; }
    .btn-primary:hover { background: #005f99; }
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,.5); display:none; justify-content:center; align-items:center; }
    .modal-content { background:white; padding:25px; border-radius:12px; width:320px; text-align:center; box-shadow:0 5px 20px rgba(0,0,0,.2); }
</style>
</head>
<body>

<div class="container">
    <h2>Ensaios Dielétricos Registrados</h2>

    <!-- FILTROS -->
    <div class="filtros">
        <input id="filtroNome" placeholder="Filtrar por nome">
        <input id="filtroEquipamento" placeholder="Filtrar por equipamento">
        <select id="filtroAprovacao">
            <option value="">Aprovação (todos)</option>
            <option value="-">Sem aprovação</option>
            <option value="ap">Aprovados</option>
        </select>
        <input id="buscaGeral" placeholder="Busca inteligente (tudo)">
    </div>

    <table id="tabela">
        <thead>
            <tr>
                <th style="width:6%;">ID</th>
                <th style="width:28%;">Nome</th>
                <th style="width:36%;">Equipamentos</th>
                <th style="width:10%;">Resultado</th>
                <th style="width:10%;">Aprovação</th>
                <th style="width:10%;">Ação</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
    <div class="modal-content">
        <h3>Nº de Aprovação</h3>
        <input id="numeroAprovacao" placeholder="000/2025">
        <br><br>
        <button class="btn btn-primary" onclick="salvarAprovacao()">Salvar</button>
        <button class="btn" onclick="fecharModal()">Cancelar</button>
    </div>
</div>

<script>
/* ============================================================
   NORMALIZAR TEXTO (sem acentos, UPPERCASE)
============================================================ */
function normalizar(str) {
  if (!str) return "";
  return str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "") // tira acentos
    .toUpperCase()
    .trim();
}

/* ============================================================
   CARREGAR IMAGENS DO REPO (mapa automático)
============================================================ */
const GITHUB_API = "https://api.github.com/repos/COEC-EPB/listar_ensaios/contents/";
const GITHUB_RAW = "https://raw.githubusercontent.com/COEC-EPB/listar_ensaios/main/";

let mapaImagens = {};

async function carregarImagensGitHub() {
  try {
    const r = await fetch(GITHUB_API);
    const arquivos = await r.json();
    arquivos.forEach(arq => {
      if (!arq.name.match(/\.(png|jpg|jpeg|jfif|tif)$/i)) return;
      let nomeOriginal = arq.name.replace(/\.(png|jpg|jpeg|jfif|tif)$/i, "");
      let chave = normalizar(nomeOriginal);
      mapaImagens[chave] = GITHUB_RAW + encodeURIComponent(arq.name);
    });
    // fallback logo local se não existir no repo
    if (!mapaImagens["ENERGISA"]) mapaImagens["ENERGISA"] = "listar_ensaios/energisa.jfif";
    console.log("mapaImagens carregado:", Object.keys(mapaImagens).length);
  } catch (err) {
    console.warn("Erro ao carregar imagens do GitHub (rate limit ou rede).", err);
  }
}

function getImagemEquipamento(equipamento) {
  if (!equipamento) return null;
  const chave = normalizar(equipamento);
  return mapaImagens[chave] || null;
}

/* ============================================================
   LISTAGEM DE ENSAIOS
============================================================ */
let ensaiosOriginais = [];
const API = "https://ensai-dieletrico.pedro-fillype.workers.dev";

async function carregar() {
  try {
    const r = await fetch(`${API}/listar-ensaios`);
    ensaiosOriginais = await r.json();
    renderizar(ensaiosOriginais);
  } catch (err) {
    console.error("Erro ao carregar ensaios:", err);
    const tbody = document.querySelector("#tabela tbody");
    if (tbody) tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:16px">Erro ao carregar registros.</td></tr>`;
  }
}

function renderizar(lista) {
  const tbody = document.querySelector("#tabela tbody");
  if (!tbody) return console.error("Tabela (#tabela tbody) não encontrada no DOM.");
  tbody.innerHTML = "";

  if (!lista || !lista.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:16px">Nenhum registro encontrado.</td></tr>`;
    return;
  }

  lista.forEach(e => {
    // botão de aprovar aparece quando não há campo aprovacao preenchido
    const btnAprovar = e.aprovacao
      ? `<button class="btn" disabled style="background:#ccc;color:#333;border-radius:6px;padding:7px 10px">Aprovado</button>`
      : `<button class="btn" style="background:#f36f21;color:#fff;border-radius:6px;padding:7px 10px" onclick="abrirModal(${e.id})">Aprovar</button>`;

    // botão gerar pdf sempre presente (usa encodeURIComponent para evitar problemas)
    const btnPdf = `<button class='btn btn-primary' onclick='gerarPDF("${encodeURIComponent(JSON.stringify(e))}")'>Gerar PDF</button>`;

    tbody.innerHTML += `
      <tr>
        <td>${e.id ?? "-"}</td>
        <td>${e.nome ?? "-"}</td>
        <td>${e.equipamentos ?? "-"}</td>
        <td>${e.resultado ?? "-"}</td>
        <td>${e.aprovacao ?? '-'}</td>
        <td style="display:flex;gap:6px;align-items:center">${btnPdf}${btnAprovar}</td>
      </tr>
    `;
  });
}

/* ============================================================
   FILTROS / BUSCA
============================================================ */
function aplicarFiltros() {
  const nome = (document.getElementById("filtroNome")?.value || "").toLowerCase();
  const eqp = (document.getElementById("filtroEquipamento")?.value || "").toLowerCase();
  const aprov = (document.getElementById("filtroAprovacao")?.value || "");
  const geral = (document.getElementById("buscaGeral")?.value || "").toLowerCase();

  const filtrados = ensaiosOriginais.filter(item => {
    return (
      (item.nome || "").toLowerCase().includes(nome) &&
      (item.equipamentos || "").toLowerCase().includes(eqp) &&
      (aprov === "" ||
        (aprov === "-" && !item.aprovacao) ||
        (aprov === "ap" && item.aprovacao)) &&
      (geral === "" || JSON.stringify(item).toLowerCase().includes(geral))
    );
  });

  renderizar(filtrados);
}

document.querySelectorAll("#filtroNome, #filtroEquipamento, #filtroAprovacao, #buscaGeral")
  .forEach(el => el && el.addEventListener("input", aplicarFiltros));

/* ============================================================
   MODAL DE APROVAÇÃO
============================================================ */
let ensaioSelecionado = null;

function abrirModal(id) {
  ensaioSelecionado = id;
  const modal = document.getElementById("modal");
  const input = document.getElementById("numeroAprovacao");
  if (input) input.value = ""; // limpa campo sempre que abrir
  if (modal) modal.style.display = "flex";
}

function fecharModal() {
  const modal = document.getElementById("modal");
  if (modal) modal.style.display = "none";
}

/* ============================
   SALVAR APROVAÇÃO
============================ */
async function salvarAprovacao() {
  const aprov = document.getElementById("numeroAprovacao")?.value?.trim();
  if (!aprov) return alert("Informe o número de aprovação antes de salvar.");
  if (!ensaioSelecionado) return alert("Nenhum ensaio selecionado.");

  try {
    const res = await fetch(`${API}/salvar-aprovacao`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: ensaioSelecionado, aprovacao: aprov })
    });
    const json = await res.json();
    if (res.ok) {
      alert(json.message || "Aprovação salva com sucesso!");
      fecharModal();
      await carregar();
    } else {
      alert(json.error || "Erro ao salvar aprovação");
    }
  } catch (err) {
    console.error("Erro ao salvar aprovação:", err);
    alert("Erro ao salvar aprovação (ver console).");
  }
}

/* ============================================================
   GERAR PDF (cliente)
   - recebe objeto serializado e codificado
   - adiciona legenda "Imagem meramente ilustrativa" abaixo da imagem
============================================================ */
async function gerarPDF(eEncoded) {
  const e = JSON.parse(decodeURIComponent(eEncoded));
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4" });
  const pageWidth = doc.internal.pageSize.getWidth();

  // meses e formatação
  const meses = [
    "01 - JANEIRO","02 - FEVEREIRO","03 - MARÇO","04 - ABRIL",
    "05 - MAIO","06 - JUNHO","07 - JULHO","08 - AGOSTO",
    "09 - SETEMBRO","10 - OUTUBRO","11 - NOVEMBRO","12 - DEZEMBRO"
  ];
  const dataFormatada = e.data ? new Date(e.data).toLocaleDateString("pt-BR") : "";
  const mes = e.data ? meses[new Date(e.data).getMonth()] : "";

  async function addImage(path, x, y, w, h) {
    if (!path) return false;
    try {
      const res = await fetch(path);
      if (!res.ok) return false;
      const blob = await res.blob();
      const reader = new FileReader();
      return new Promise(resolve => {
        reader.onload = () => {
          const base64 = reader.result;
          const mime = base64.split(",")[0].match(/data:(image\/[a-zA-Z]+);/);
          const fmt = mime && /png/i.test(mime[1]) ? "PNG" : "JPEG";
          try {
            doc.addImage(base64, fmt, x, y, w, h);
            resolve(true);
          } catch (err) {
            console.warn("addImage falhou (formato não suportado?):", err);
            resolve(false);
          }
        };
        reader.readAsDataURL(blob);
      });
    } catch (err) {
      return false;
    }
  }

  // header (logo)
  const logoPath = mapaImagens["ENERGISA"] || "listar_ensaios/energisa.jfif";
  await addImage(logoPath, 14, 8, 30, 18).catch(()=>{});
  doc.setFontSize(16).setFont("Helvetica", "bold");
  doc.text("LAUDO DE ENSAIO DIELÉTRICO", pageWidth/2, 16, { align: "center" });

  let y = 30;

  // cabeçalho reduzido
  doc.autoTable({
    startY: y,
    tableWidth: 150,
    margin: { left: 14 },
    head: [["Laudo", "Valor"]],
    headStyles: { fillColor: [0,102,166], textColor: 255 },
    styles: { fontSize: 9 },
    body: [
      ["Laudo", "EPB/EBO"],
      ["Certificado nº", e.aprovacao ?? "-"],
      ["Mês do Ensaio", mes],
      ["Regional", e.regional ?? "-"],
      ["Localidade", e.localidade ?? "-"],
      ["Departamento", e.departamento ?? "-"]
    ]
  });

  y = doc.lastAutoTable.finalY + 10;

  // imagem do equipamento (direita) + legenda se adicionada
  const imgX = 150, imgY = y, imgW = 40, imgH = 40;
  const caminhoImg = getImagemEquipamento(e.equipamentos);
  const added = caminhoImg ? await addImage(caminhoImg, imgX, imgY, imgW, imgH) : false;
  if (added) {
    doc.setFont("Helvetica", "italic");
    doc.setFontSize(7.5);
    doc.text("Imagem meramente ilustrativa", imgX + imgW/2, imgY + imgH + 4, { align: "center" });
    doc.setFont("Helvetica", "normal");
    doc.setFontSize(9);
  }

  // tabela laranja esquerda
  doc.autoTable({
    startY: y,
    tableWidth: 120,
    margin: { left: 14 },
    head: [["Campo", "Valor"]],
    headStyles: { fillColor: [243,111,33], textColor: 255 },
    styles: { fontSize: 9 },
    body: [
      ["Equipamento", e.equipamentos ?? "-"],
      ["Tipo de Ensaio", e.tipo_ensaio ?? "-"],
      ["Norma Aplicada", e.norma ?? "-"]
    ]
  });

  y = Math.max(doc.lastAutoTable.finalY, imgY + (added ? imgH + 8 : 0)) + 10;

  // tabela de códigos
  const ini = Number(e.cod_inicial || 0);
  const fim = Number(e.cod_final || ini);
  const rows = [];
  for (let i = ini; i <= fim; i++) rows.push([String(i), String(i), `${e.corrente_fuga} µA`, (e.resultado || "").toUpperCase()]);

  doc.autoTable({
    startY: y,
    head: [["Código", "Rastreamento", "Corrente de Fuga", "Resultado"]],
    styles: { fontSize: 9 },
    headStyles: { fillColor: [0,102,166], textColor: 255 },
    body: rows,
    margin: { left: 14, right: 14 }
  });

  y = doc.lastAutoTable.finalY + 10;

  // observações
  doc.setFont("Helvetica", "bold").setFontSize(10);
  doc.text("Observações", 14, y);
  y += 4;
  doc.line(14, y, pageWidth - 14, y);
  y += 6;

  doc.setFont("Helvetica", "normal").setFontSize(8.5);
  const obs = [
    "• Os EPI’s e EPC’s com código de rastreio correspondente ao laudo estão aprovados para uso em campo.",
    "• Ensaio de Tensão Aplicada: Verifica a capacidade dielétrica sem rompimento ou excesso de corrente.",
    "• ART do Ensaio Dielétrico: -",
    "• Equipamento Utilizado: Testador de Alta Tensão EEAT – AT120050CADMT2SAURS232.",
    "• Condições Ambientais: Temperatura: 30°C | Umidade: 50% | Pressão: 970 mbar",
    "• Observações gerais: Incerteza de tensão: ±0,05% | Incerteza de corrente: ±0,01%"
  ];
  for (const line of obs) {
    doc.text(line, 14, y);
    y += 5;
    if (y > doc.internal.pageSize.height - 60) {
      doc.addPage();
      y = 20;
    }
  }

  // assinatura
  y += 12;
  if (y > doc.internal.pageSize.height - 30) {
    doc.addPage();
    y = 30;
  }
  doc.setFontSize(10);
  doc.text("__________________________________________", pageWidth/2, y, { align: "center" });
  y += 6;
  doc.setFont("Helvetica", "bold");
  doc.text("Wesley Fernandes de Souza", pageWidth/2, y, { align: "center" });
  y += 5;
  doc.setFont("Helvetica", "normal");
  doc.setFontSize(9);
  doc.text("Responsável Técnico – CREA-PB: 1605187852", pageWidth/2, y, { align: "center" });

  doc.save(`laudo_${e.id || Date.now()}.pdf`);
}

/* ============================================================
   INICIALIZAÇÃO
============================================================ */
(async () => {
  await carregarImagensGitHub();
  await carregar();
})();
</script>



</body>
</html>
